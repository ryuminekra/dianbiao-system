# 电表管理系统开发文档

## 1. 项目概述

电表管理系统是一个用于管理电表设备、读取电表数据、设置电价的综合管理系统。系统分为前端和后端两部分，前端负责用户界面和交互，后端负责数据存储和业务逻辑处理。

### 1.1 主要功能

- **用户管理**：用户登录、用户信息管理
- **设备管理**：电表设备的添加、编辑、删除和状态监控
- **区域管理**：区域的添加、编辑、删除
- **电价管理**：电价的添加、编辑、删除，支持区域关联
- **电表数据**：电表读数的自动采集和手动录入
- **数据统计**：用电量和费用的计算与统计

## 2. 技术栈

### 2.1 前端技术栈

- **框架**：React 18
- **语言**：TypeScript
- **UI组件库**：Ant Design
- **状态管理**：Redux Toolkit
- **HTTP客户端**：Axios
- **构建工具**：Vite

### 2.2 后端技术栈

- **框架**：Express.js
- **语言**：Node.js
- **数据库**：MongoDB
- **ORM**：Mongoose
- **认证**：JWT (JSON Web Token)

## 3. 项目结构

### 3.1 前端项目结构

```
dianbiao-app/
├── public/             # 静态资源
├── src/                # 源代码
│   ├── assets/         # 资源文件
│   ├── pages/          # 页面组件
│   │   ├── AreaSettingPage.tsx         # 区域设置页面
│   │   ├── ElectricityPricePage.tsx    # 电价设置页面
│   │   ├── HardwareManagementPage.tsx  # 硬件管理页面
│   │   ├── LoginPage.tsx               # 登录页面
│   │   ├── ManualMeterReadingPage.tsx  # 手动抄表页面
│   │   ├── MeterDetailPage.tsx         # 电表详情页面
│   │   ├── MeterOverviewPage.tsx       # 电表概览页面
│   │   ├── UserManagementPage.tsx      # 用户管理页面
│   │   └── UserProfilePage.tsx         # 用户资料页面
│   ├── store/          # Redux状态管理
│   │   ├── slices/     # Redux切片
│   │   │   ├── authSlice.ts        # 认证相关状态
│   │   │   ├── deviceSlice.ts      # 设备相关状态
│   │   │   ├── metricSlice.ts      # 指标相关状态
│   │   │   └── priceSlice.ts       # 价格相关状态
│   │   └── index.ts    # Redux存储配置
│   ├── types/          # TypeScript类型定义
│   ├── App.tsx         # 应用根组件
│   ├── main.tsx        # 应用入口
│   └── index.css       # 全局样式
├── package.json        # 项目配置和依赖
├── tsconfig.json       # TypeScript配置
└── vite.config.ts      # Vite配置
```

### 3.2 后端项目结构

```
dianbiao-backend/
├── middleware/         # 中间件
│   └── auth.js         # 认证中间件
├── models/             # 数据库模型
│   ├── Area.js         # 区域模型
│   ├── Building.js     # 建筑模型
│   ├── Device.js       # 设备模型
│   ├── ElectricityPrice.js  # 电价模型
│   ├── Floor.js        # 楼层模型
│   ├── Metric.js       # 指标模型
│   ├── Room.js         # 房间模型
│   └── User.js         # 用户模型
├── routes/             # API路由
│   ├── areas.js        # 区域相关路由
│   ├── auth.js         # 认证相关路由
│   ├── devices.js      # 设备相关路由
│   ├── metrics.js      # 指标相关路由
│   └── prices.js       # 价格相关路由
├── index.js            # 应用入口
├── init-data.js        # 初始数据脚本
├── package.json        # 项目配置和依赖
└── .env                # 环境变量配置
```

## 4. 核心功能模块

### 4.1 用户认证模块

**功能**：用户登录、权限验证

**实现**：
- 前端使用JWT进行身份验证
- 后端使用bcrypt进行密码加密，使用jsonwebtoken生成JWT令牌
- 中间件验证用户权限，区分普通用户和管理员

**关键文件**：
- 前端：`src/pages/LoginPage.tsx`
- 后端：`middleware/auth.js`, `routes/auth.js`, `models/User.js`

### 4.2 设备管理模块

**功能**：设备的添加、编辑、删除、状态监控

**实现**：
- 前端提供设备管理界面，支持设备信息的CRUD操作
- 后端提供设备相关的API接口
- 设备状态通过指标数据实时更新

**关键文件**：
- 前端：`src/pages/HardwareManagementPage.tsx`
- 后端：`routes/devices.js`, `models/Device.js`

### 4.3 区域管理模块

**功能**：区域的添加、编辑、删除

**实现**：
- 前端提供区域管理界面，支持区域信息的CRUD操作
- 后端提供区域相关的API接口
- 区域信息关联到设备和电价

**关键文件**：
- 前端：`src/pages/AreaSettingPage.tsx`
- 后端：`routes/areas.js`, `models/Area.js`

### 4.4 电价管理模块

**功能**：电价的添加、编辑、删除，支持区域关联

**实现**：
- 前端提供电价管理界面，支持电价信息的CRUD操作
- 电价设置支持区域下拉选择，关联到区域管理中的区域
- 后端提供电价相关的API接口

**关键文件**：
- 前端：`src/pages/ElectricityPricePage.tsx`
- 后端：`routes/prices.js`, `models/ElectricityPrice.js`

### 4.5 电表数据模块

**功能**：电表读数的自动采集和手动录入，用电量和费用计算

**实现**：
- 前端提供手动抄表界面，支持手动录入电表读数
- 后端支持自动采集电表数据
- 系统自动计算用电量和费用

**关键文件**：
- 前端：`src/pages/ManualMeterReadingPage.tsx`, `src/pages/MeterDetailPage.tsx`
- 后端：`routes/metrics.js`, `models/Metric.js`

## 5. API接口

### 5.1 认证接口

- **POST /api/auth/login**：用户登录
  - 请求体：`{"username": "admin", "password": "123456"}`
  - 响应：`{"token": "jwt_token", "user": {"_id": "...", "username": "admin", "role": "admin"}}`

### 5.2 区域接口

- **GET /api/areas**：获取所有区域
  - 响应：`[{"_id": "...", "name": "区域1", "remark": "..."}]`

- **POST /api/areas**：添加区域（仅管理员）
  - 请求体：`{"name": "区域1", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "区域1", "remark": "..."}`

- **PUT /api/areas/:id**：编辑区域（仅管理员）
  - 请求体：`{"name": "区域1", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "区域1", "remark": "..."}`

- **DELETE /api/areas/:id**：删除区域（仅管理员）
  - 响应：`{"message": "区域删除成功"}`

### 5.3 设备接口

- **GET /api/devices**：获取所有设备
  - 响应：`[{"_id": "...", "device_id": "...", "area": "...", "address": "..."}]`

- **POST /api/devices**：添加设备（仅管理员）
  - 请求体：`{"device_id": "...", "area": "...", "address": "..."}`
  - 响应：`{"_id": "...", "device_id": "...", "area": "...", "address": "..."}`

- **PUT /api/devices/:id**：编辑设备（仅管理员）
  - 请求体：`{"device_id": "...", "area": "...", "address": "..."}`
  - 响应：`{"_id": "...", "device_id": "...", "area": "...", "address": "..."}`

- **DELETE /api/devices/:id**：删除设备（仅管理员）
  - 响应：`{"message": "设备删除成功"}`

### 5.4 电价接口

- **GET /api/prices**：获取所有电价
  - 响应：`[{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}]`

- **POST /api/prices**：添加电价（仅管理员）
  - 请求体：`{"area": "...", "price": 0.5}`
  - 响应：`{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}`

- **PUT /api/prices/:id**：编辑电价（仅管理员）
  - 请求体：`{"area": "...", "price": 0.5}`
  - 响应：`{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}`

- **DELETE /api/prices/:id**：删除电价（仅管理员）
  - 响应：`{"message": "电价删除成功"}`

### 5.5 电表数据接口

- **GET /api/metrics/device/:deviceId**：获取设备的电表数据
  - 响应：`[{"_id": "...", "device_id": "...", "value": 100, "timestamp": "..."}]`

- **GET /api/metrics/overview**：获取所有电表的最新数据（概览）
  - 响应：`[{"device_id": "...", "device_number": "...", "area": "...", "current_reading": 100, "last_updated": "..."}]`

- **GET /api/metrics/monthly/:deviceId**：计算月度用电量和费用
  - 响应：`{"usage": 50, "cost": 25, "price": 0.5, "data": [...]}`

- **POST /api/metrics**：添加电表数据
  - 请求体：`{"device_id": "...", "value": 100, "timestamp": "..."}`
  - 响应：`{"_id": "...", "device_id": "...", "value": 100, "timestamp": "..."}`

## 6. 数据库模型

### 6.1 用户模型 (User.js)

```javascript
const userSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true,
    unique: true
  },
  password: {
    type: String,
    required: true
  },
  role: {
    type: String,
    enum: ['user', 'admin'],
    default: 'user'
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.2 区域模型 (Area.js)

```javascript
const areaSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    unique: true
  },
  remark: {
    type: String
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.3 设备模型 (Device.js)

```javascript
const deviceSchema = new mongoose.Schema({
  device_id: {
    type: String,
    required: true,
    unique: true
  },
  area_id: {
    type: String,
    required: true
  },
  area: {
    type: String,
    required: true
  },
  floor_id: {
    type: String,
    required: true
  },
  floor: {
    type: String,
    required: true
  },
  room_id: {
    type: String,
    required: true
  },
  room: {
    type: String,
    required: true
  },
  remark: {
    type: String
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.4 电价模型 (ElectricityPrice.js)

```javascript
const electricityPriceSchema = new mongoose.Schema({
  area: {
    type: String,
    required: true
  },
  price: {
    type: Number,
    required: true
  },
  effective_date: {
    type: Date,
    default: Date.now
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.5 指标模型 (Metric.js)

```javascript
const metricSchema = new mongoose.Schema({
  device_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Device',
    required: true
  },
  value: {
    type: Number,
    required: true
  },
  timestamp: {
    type: Date,
    default: Date.now
  },
  month: {
    type: String,
    required: true
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

## 7. 前端状态管理

### 7.1 认证状态 (authSlice.ts)

```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  loading: boolean;
  error: string | null;
}

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    loginSuccess: (state, action: PayloadAction<{ user: User; token: string }>) => {
      state.user = action.payload.user;
      state.token = action.payload.token;
      state.isAuthenticated = true;
      state.loading = false;
      state.error = null;
    },
    logout: (state) => {
      state.user = null;
      state.token = null;
      state.isAuthenticated = false;
      state.loading = false;
      state.error = null;
    }
  }
});
```

### 7.2 设备状态 (deviceSlice.ts)

```typescript
interface DeviceState {
  devices: Device[];
  loading: boolean;
  error: string | null;
}

const deviceSlice = createSlice({
  name: 'device',
  initialState,
  reducers: {
    setDevices: (state, action: PayloadAction<Device[]>) => {
      state.devices = action.payload;
      state.loading = false;
      state.error = null;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
      state.loading = false;
    }
  }
});
```

### 7.3 价格状态 (priceSlice.ts)

```typescript
interface ElectricityPrice {
  _id: string;
  area: string;
  price: number;
  is_default: boolean;
  effective_date: string;
  created_at: string;
  updated_at: string;
}

interface PriceState {
  prices: ElectricityPrice[];
  loading: boolean;
  error: string | null;
}

const priceSlice = createSlice({
  name: 'price',
  initialState,
  reducers: {
    setPrices: (state, action: PayloadAction<ElectricityPrice[]>) => {
      state.prices = action.payload;
      state.loading = false;
      state.error = null;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
      state.loading = false;
    }
  }
});
```

## 8. 部署与运行

### 8.1 前端部署

1. **安装依赖**：
   ```bash
   cd dianbiao-app
   npm install
   ```

2. **开发环境运行**：
   ```bash
   npm run dev
   ```

3. **生产环境构建**：
   ```bash
   npm run build
   ```

### 8.2 后端部署

1. **安装依赖**：
   ```bash
   cd dianbiao-backend
   npm install
   ```

2. **启动服务器**：
   ```bash
   node index.js
   ```

3. **环境变量配置**：
   创建 `.env` 文件，配置数据库连接信息和端口：
   ```
   PORT=5000
   MONGODB_URI=mongodb://localhost:27017/dianbiao
   JWT_SECRET=your_jwt_secret
   ```

## 9. 注意事项

1. **数据库连接**：确保 MongoDB 服务已启动，并且连接字符串正确。

2. **权限管理**：系统区分普通用户和管理员权限，管理员可以进行所有操作，普通用户只能查看数据。

3. **数据验证**：前端和后端都进行了数据验证，确保数据的正确性和完整性。

4. **错误处理**：系统对各种错误情况进行了处理，确保系统的稳定性和用户体验。

5. **性能优化**：
   - 前端使用 React.memo 和 useCallback 等钩子进行性能优化
   - 后端使用数据库索引和查询优化提升性能

## 10. 版本历史

| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0.0 | 2026-02-07 | 初始版本 |
| 1.0.1 | 2026-02-08 | 更新电价管理功能，添加区域关联 |

## 11. 后续计划

1. **添加数据可视化**：使用图表库展示用电量和费用趋势。

2. **优化用户界面**：提升用户界面的美观度和用户体验。

3. **添加更多设备类型支持**：支持多种类型的电表设备。

4. **实现数据导出功能**：支持将数据导出为Excel或PDF格式。

5. **添加系统日志**：记录系统操作日志，便于故障排查。

6. **优化移动端适配**：提升系统在移动端的使用体验。