# 电表管理系统开发文档 v1.0.5

## 1. 项目概述

电表管理系统是一个用于管理电表设备、读取电表数据、设置电价的综合管理系统。系统分为前端和后端两部分，前端负责用户界面和交互，后端负责数据存储和业务逻辑处理。

### 1.1 主要功能

- **用户管理**：用户登录、用户信息管理
- **设备管理**：电表设备的添加、编辑、删除和状态监控
- **区域管理**：区域的添加、编辑、删除，支持区域-楼层-房间三级管理
- **电价管理**：电价的添加、编辑、删除，支持区域关联
- **电表数据**：电表读数的自动采集和手动录入
- **数据统计**：用电量和费用的计算与统计，支持数据可视化

## 2. 技术栈

### 2.1 前端技术栈

- **框架**：React 18
- **语言**：TypeScript
- **UI组件库**：Ant Design
- **状态管理**：Redux Toolkit
- **HTTP客户端**：Axios
- **构建工具**：Vite
- **图表库**：Recharts

### 2.2 后端技术栈

- **框架**：Express.js
- **语言**：Node.js
- **数据库**：MongoDB
- **ORM**：Mongoose
- **认证**：JWT (JSON Web Token)

## 3. 项目结构

### 3.1 前端项目结构

```
dianbiao-app/
├── public/             # 静态资源
├── src/                # 源代码
│   ├── assets/         # 资源文件
│   ├── pages/          # 页面组件
│   │   ├── AreaSettingPage.tsx         # 区域设置页面
│   │   ├── ElectricityPricePage.tsx    # 电价设置页面
│   │   ├── HardwareManagementPage.tsx  # 硬件管理页面
│   │   ├── LoginPage.tsx               # 登录页面
│   │   ├── ManualMeterReadingPage.tsx  # 手动抄表页面
│   │   ├── MeterDetailPage.tsx         # 电表详情页面
│   │   ├── MeterOverviewPage.tsx       # 电表概览页面
│   │   ├── SystemLogPage.tsx           # 系统日志页面
│   │   ├── UserManagementPage.tsx      # 用户管理页面
│   │   └── UserProfilePage.tsx         # 用户资料页面
│   ├── store/          # Redux状态管理
│   │   ├── slices/     # Redux切片
│   │   │   ├── authSlice.ts        # 认证相关状态
│   │   │   ├── deviceSlice.ts      # 设备相关状态
│   │   │   ├── metricSlice.ts      # 指标相关状态
│   │   │   └── priceSlice.ts       # 价格相关状态
│   │   └── index.ts    # Redux存储配置
│   ├── types/          # TypeScript类型定义
│   ├── App.css         # 应用样式
│   ├── App.tsx         # 应用根组件
│   ├── index.css       # 全局样式
│   └── main.tsx        # 应用入口
├── package.json        # 项目配置和依赖
├── tsconfig.json       # TypeScript配置
└── vite.config.ts      # Vite配置
```

### 3.2 后端项目结构

```
dianbiao-backend/
├── middleware/         # 中间件
│   ├── auth.js         # 认证中间件
│   └── logger.js       # 日志中间件
├── models/             # 数据库模型
│   ├── Area.js         # 区域模型
│   ├── Building.js     # 建筑模型
│   ├── DefaultElectricityPrice.js  # 默认电价模型
│   ├── Device.js       # 设备模型
│   ├── ElectricityPrice.js  # 电价模型
│   ├── Floor.js        # 楼层模型
│   ├── Log.js          # 日志模型
│   ├── Metric.js       # 指标模型
│   ├── Room.js         # 房间模型
│   └── User.js         # 用户模型
├── routes/             # API路由
│   ├── areas.js        # 区域相关路由
│   ├── auth.js         # 认证相关路由
│   ├── devices.js      # 设备相关路由
│   ├── floors.js       # 楼层相关路由
│   ├── logs.js         # 日志相关路由
│   ├── metrics.js      # 指标相关路由
│   ├── prices.js       # 价格相关路由
│   └── rooms.js        # 房间相关路由
├── utils/              # 工具函数
│   └── cronJobs.js     # 定时任务
├── index.js            # 应用入口
├── init-data.js        # 初始数据脚本
├── package.json        # 项目配置和依赖
└── .env                # 环境变量配置
```

## 4. 核心功能模块

### 4.1 用户认证模块

**功能**：用户登录、权限验证

**实现**：
- 前端使用JWT进行身份验证
- 后端使用bcrypt进行密码加密，使用jsonwebtoken生成JWT令牌
- 中间件验证用户权限，区分普通用户和管理员

**关键文件**：
- 前端：`src/pages/LoginPage.tsx`
- 后端：`middleware/auth.js`, `routes/auth.js`, `models/User.js`

### 4.2 设备管理模块

**功能**：设备的添加、编辑、删除、状态监控

**实现**：
- 前端提供设备管理界面，支持设备信息的CRUD操作
- 后端提供设备相关的API接口
- 设备状态通过指标数据实时更新

**关键文件**：
- 前端：`src/pages/HardwareManagementPage.tsx`
- 后端：`routes/devices.js`, `models/Device.js`

### 4.3 区域管理模块

**功能**：区域的添加、编辑、删除，支持区域-楼层-房间三级管理

**实现**：
- 前端提供区域管理界面，支持区域、楼层、房间的三级管理
- 后端提供区域、楼层、房间相关的API接口
- 区域信息关联到设备和电价

**关键文件**：
- 前端：`src/pages/AreaSettingPage.tsx`
- 后端：`routes/areas.js`, `routes/floors.js`, `routes/rooms.js`, `models/Area.js`, `models/Floor.js`, `models/Room.js`

### 4.4 电价管理模块

**功能**：电价的添加、编辑、删除，支持区域关联

**实现**：
- 前端提供电价管理界面，支持电价信息的CRUD操作
- 电价设置支持区域下拉选择，关联到区域管理中的区域
- 后端提供电价相关的API接口

**关键文件**：
- 前端：`src/pages/ElectricityPricePage.tsx`
- 后端：`routes/prices.js`, `models/ElectricityPrice.js`, `models/DefaultElectricityPrice.js`

### 4.5 电表数据模块

**功能**：电表读数的自动采集和手动录入，用电量和费用计算

**实现**：
- 前端提供手动抄表界面，支持手动录入电表读数
- 后端支持自动采集电表数据
- 系统自动计算用电量和费用

**关键文件**：
- 前端：`src/pages/ManualMeterReadingPage.tsx`, `src/pages/MeterDetailPage.tsx`
- 后端：`routes/metrics.js`, `models/Metric.js`

### 4.6 数据可视化模块

**功能**：用电量和费用的可视化展示

**实现**：
- 前端使用Recharts库实现数据可视化
- 在电表概览页面添加饼图，展示区域、楼层和房间的耗电百分比
- 支持总耗电量和总费用的实时展示

**关键文件**：
- 前端：`src/pages/MeterOverviewPage.tsx`
- 后端：`routes/metrics.js`

## 5. API接口

### 5.1 认证接口

- **POST /api/auth/login**：用户登录
  - 请求体：`{"username": "admin", "password": "123456"}`
  - 响应：`{"token": "jwt_token", "user": {"_id": "...", "username": "admin", "role": "admin"}}`

### 5.2 区域接口

- **GET /api/areas**：获取所有区域
  - 响应：`[{"_id": "...", "name": "区域1", "remark": "..."}]`

- **POST /api/areas**：添加区域（仅管理员）
  - 请求体：`{"name": "区域1", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "区域1", "remark": "..."}`

- **PUT /api/areas/:id**：编辑区域（仅管理员）
  - 请求体：`{"name": "区域1", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "区域1", "remark": "..."}`

- **DELETE /api/areas/:id**：删除区域（仅管理员）
  - 响应：`{"message": "区域删除成功"}`

### 5.3 楼层接口

- **GET /api/areas/:areaId/floors**：获取指定区域的所有楼层
  - 响应：`[{"_id": "...", "name": "1楼", "area_id": "...", "remark": "..."}]`

- **POST /api/areas/:areaId/floors**：添加楼层（仅管理员）
  - 请求体：`{"name": "1楼", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "1楼", "area_id": "...", "remark": "..."}`

- **PUT /api/areas/floors/:id**：编辑楼层（仅管理员）
  - 请求体：`{"name": "1楼", "area_id": "...", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "1楼", "area_id": "...", "remark": "..."}`

- **DELETE /api/areas/floors/:id**：删除楼层（仅管理员）
  - 响应：`{"message": "楼层删除成功"}`

### 5.4 房间接口

- **GET /api/areas/:floorId/rooms**：获取指定楼层的所有房间
  - 响应：`[{"_id": "...", "name": "101", "floor_id": "...", "remark": "..."}]`

- **POST /api/areas/:floorId/rooms**：添加房间（仅管理员）
  - 请求体：`{"name": "101", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "101", "floor_id": "...", "remark": "..."}`

- **PUT /api/areas/rooms/:id**：编辑房间（仅管理员）
  - 请求体：`{"name": "101", "floor_id": "...", "remark": "..."}`
  - 响应：`{"_id": "...", "name": "101", "floor_id": "...", "remark": "..."}`

- **DELETE /api/areas/rooms/:id**：删除房间（仅管理员）
  - 响应：`{"message": "房间删除成功"}`

### 5.5 设备接口

- **GET /api/devices**：获取所有设备
  - 响应：`[{"_id": "...", "device_id": "...", "area": "...", "area_id": "...", "floor_id": "...", "floor": "...", "room_id": "...", "room": "...", "remark": "..."}]`

- **POST /api/devices**：添加设备（仅管理员）
  - 请求体：`{"device_id": "...", "area_id": "...", "area": "...", "floor_id": "...", "floor": "...", "room_id": "...", "room": "...", "remark": "..."}`
  - 响应：`{"_id": "...", "device_id": "...", "area": "...", "area_id": "...", "floor_id": "...", "floor": "...", "room_id": "...", "room": "...", "remark": "..."}`

- **PUT /api/devices/:id**：编辑设备（仅管理员）
  - 请求体：`{"device_id": "...", "area_id": "...", "area": "...", "floor_id": "...", "floor": "...", "room_id": "...", "room": "...", "remark": "..."}`
  - 响应：`{"_id": "...", "device_id": "...", "area": "...", "area_id": "...", "floor_id": "...", "floor": "...", "room_id": "...", "room": "...", "remark": "..."}`

- **DELETE /api/devices/:id**：删除设备（仅管理员）
  - 响应：`{"message": "设备删除成功"}`

### 5.6 电价接口

- **GET /api/prices**：获取所有电价
  - 响应：`[{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}]`

- **POST /api/prices**：添加电价（仅管理员）
  - 请求体：`{"area": "...", "price": 0.5}`
  - 响应：`{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}`

- **PUT /api/prices/:id**：编辑电价（仅管理员）
  - 请求体：`{"area": "...", "price": 0.5}`
  - 响应：`{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}`

- **DELETE /api/prices/:id**：删除电价（仅管理员）
  - 响应：`{"message": "电价删除成功"}`

- **GET /api/prices/default**：获取默认电价
  - 响应：`{"_id": "...", "price": 1.0, "effective_date": "..."}`

### 5.7 电表数据接口

- **GET /api/metrics/device/:deviceId**：获取设备的电表数据
  - 响应：`[{"_id": "...", "device_id": "...", "value": 100, "timestamp": "..."}]`

- **GET /api/metrics/overview**：获取所有电表的最新数据（概览）
  - 响应：`[{"device_id": "...", "device_number": "...", "area": "...", "current_reading": 100, "last_updated": "..."}]`

- **GET /api/metrics/monthly/:deviceId**：计算月度用电量和费用
  - 响应：`{"usage": 50, "cost": 25, "price": 0.5, "data": [...]}`

- **GET /api/metrics/area-stats**：获取区域耗电量统计数据
  - 响应：`{"totalUsage": 1000, "totalCost": 500, "stats": [{"area": "...", "usage": 500, "cost": 250, "percentage": 50, "floors": [...]}]}`

- **POST /api/metrics**：添加电表数据
  - 请求体：`{"device_id": "...", "value": 100, "timestamp": "..."}`
  - 响应：`{"_id": "...", "device_id": "...", "value": 100, "timestamp": "..."}`

## 6. 数据库模型

### 6.1 用户模型 (User.js)

```javascript
const userSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true,
    unique: true
  },
  password: {
    type: String,
    required: true
  },
  role: {
    type: String,
    enum: ['user', 'admin'],
    default: 'user'
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.2 区域模型 (Area.js)

```javascript
const areaSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    unique: true
  },
  remark: {
    type: String
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.3 楼层模型 (Floor.js)

```javascript
const floorSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true
  },
  area_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Area',
    required: true
  },
  remark: {
    type: String
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.4 房间模型 (Room.js)

```javascript
const roomSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true
  },
  floor_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Floor',
    required: true
  },
  remark: {
    type: String
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.5 设备模型 (Device.js)

```javascript
const deviceSchema = new mongoose.Schema({
  device_id: {
    type: String,
    required: true,
    unique: true
  },
  area_id: {
    type: String,
    required: true
  },
  area: {
    type: String,
    required: true
  },
  floor_id: {
    type: String,
    required: true
  },
  floor: {
    type: String,
    required: true
  },
  room_id: {
    type: String,
    required: true
  },
  room: {
    type: String,
    required: true
  },
  remark: {
    type: String
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.6 电价模型 (ElectricityPrice.js)

```javascript
const electricityPriceSchema = new mongoose.Schema({
  area: {
    type: String,
    required: true
  },
  price: {
    type: Number,
    required: true
  },
  effective_date: {
    type: Date,
    default: Date.now
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.7 默认电价模型 (DefaultElectricityPrice.js)

```javascript
const defaultElectricityPriceSchema = new mongoose.Schema({
  price: {
    type: Number,
    required: true
  },
  effective_date: {
    type: Date,
    default: Date.now
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

### 6.8 指标模型 (Metric.js)

```javascript
const metricSchema = new mongoose.Schema({
  device_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Device',
    required: true
  },
  value: {
    type: Number,
    required: true
  },
  timestamp: {
    type: Date,
    default: Date.now
  },
  month: {
    type: String,
    required: true
  },
  created_at: {
    type: Date,
    default: Date.now
  },
  updated_at: {
    type: Date,
    default: Date.now
  }
});
```

## 7. 前端状态管理

### 7.1 认证状态 (authSlice.ts)

```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  loading: boolean;
  error: string | null;
}

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    loginSuccess: (state, action: PayloadAction<{ user: User; token: string }>) => {
      state.user = action.payload.user;
      state.token = action.payload.token;
      state.isAuthenticated = true;
      state.loading = false;
      state.error = null;
    },
    logout: (state) => {
      state.user = null;
      state.token = null;
      state.isAuthenticated = false;
      state.loading = false;
      state.error = null;
    }
  }
});
```

### 7.2 设备状态 (deviceSlice.ts)

```typescript
interface DeviceState {
  devices: Device[];
  loading: boolean;
  error: string | null;
}

const deviceSlice = createSlice({
  name: 'device',
  initialState,
  reducers: {
    setDevices: (state, action: PayloadAction<Device[]>) => {
      state.devices = action.payload;
      state.loading = false;
      state.error = null;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
      state.loading = false;
    }
  }
});
```

### 7.3 指标状态 (metricSlice.ts)

```typescript
interface MetricState {
  metrics: Metric[];
  overview: MeterOverview[];
  areaStats: AreaStat[];
  totalUsage: number;
  totalCost: number;
  loading: boolean;
  error: string | null;
}

const metricSlice = createSlice({
  name: 'metric',
  initialState,
  reducers: {
    setMetrics: (state, action: PayloadAction<Metric[]>) => {
      state.metrics = action.payload;
      state.loading = false;
      state.error = null;
    },
    setOverview: (state, action: PayloadAction<MeterOverview[]>) => {
      state.overview = action.payload;
      state.loading = false;
      state.error = null;
    },
    setAreaStats: (state, action: PayloadAction<{ stats: AreaStat[]; totalUsage: number; totalCost: number }>) => {
      state.areaStats = action.payload.stats;
      state.totalUsage = action.payload.totalUsage;
      state.totalCost = action.payload.totalCost;
      state.loading = false;
      state.error = null;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
      state.loading = false;
    }
  }
});
```

### 7.4 价格状态 (priceSlice.ts)

```typescript
interface ElectricityPrice {
  _id: string;
  area: string;
  price: number;
  is_default: boolean;
  effective_date: string;
  created_at: string;
  updated_at: string;
}

interface PriceState {
  prices: ElectricityPrice[];
  defaultPrice: number;
  loading: boolean;
  error: string | null;
}

const priceSlice = createSlice({
  name: 'price',
  initialState,
  reducers: {
    setPrices: (state, action: PayloadAction<ElectricityPrice[]>) => {
      state.prices = action.payload;
      state.loading = false;
      state.error = null;
    },
    setDefaultPrice: (state, action: PayloadAction<number>) => {
      state.defaultPrice = action.payload;
      state.loading = false;
      state.error = null;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.loading = action.payload;
    },
    setError: (state, action: PayloadAction<string | null>) => {
      state.error = action.payload;
      state.loading = false;
    }
  }
});
```

## 8. 部署与运行

### 8.1 前端部署

1. **安装依赖**：
   ```bash
   cd dianbiao-app
   npm install
   ```

2. **开发环境运行**：
   ```bash
   npm run dev
   ```

3. **生产环境构建**：
   ```bash
   npm run build
   ```

### 8.2 后端部署

1. **安装依赖**：
   ```bash
   cd dianbiao-backend
   npm install
   ```

2. **启动服务器**：
   ```bash
   node index.js
   ```

3. **环境变量配置**：
   创建 `.env` 文件，配置数据库连接信息和端口：
   ```
   PORT=5000
   MONGO_URI=mongodb://localhost:27017/dianbiao
   JWT_SECRET=your_jwt_secret
   ```

## 9. 注意事项

1. **数据库连接**：确保 MongoDB 服务已启动，并且连接字符串正确。

2. **权限管理**：系统区分普通用户和管理员权限，管理员可以进行所有操作，普通用户只能查看数据。

3. **数据验证**：前端和后端都进行了数据验证，确保数据的正确性和完整性。

4. **错误处理**：系统对各种错误情况进行了处理，确保系统的稳定性和用户体验。

5. **性能优化**：
   - 前端使用 React.memo 和 useCallback 等钩子进行性能优化
   - 后端使用数据库索引和查询优化提升性能

6. **区域-楼层-房间关联**：设备添加时需要选择所属的区域、楼层和房间，确保数据的关联性。

7. **电价设置**：每个区域可以设置不同的电价，系统会根据设备所属区域的电价计算费用。

8. **总耗电量计算**：总耗电量等于园区所有电表读数的总和，系统会实时更新显示。

9. **数据可视化**：电表概览页面使用饼图展示区域、楼层和房间的耗电百分比，直观展示用电分布。

10. **API访问权限**：`/api/metrics/area-stats` 接口已移除身份验证限制，便于前端直接访问获取统计数据。

## 10. 版本历史

| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0.0 | 2026-02-07 | 初始版本 |
| 1.0.1 | 2026-02-08 | 更新电价管理功能，添加区域关联 |
| 1.0.2 | 2026-02-08 | 添加区域-楼层-房间三级管理功能，完善设备管理模块 |
| 1.0.3 | 2026-02-08 | 添加系统日志功能，优化用户界面 |
| 1.0.4 | 2026-02-08 | 优化电表数据采集和存储，提升系统性能 |
| 1.0.5 | 2026-02-08 | 1. 修改电表概览页面，添加三个饼图展示区域、楼层和房间的耗电百分比<br>2. 修改总耗电量计算逻辑，使其等于园区所有电表读数的总和<br>3. 移除 `/api/metrics/area-stats` 接口的身份验证限制，便于前端直接访问 |

## 11. 后续计划

1. **添加更多数据可视化图表**：使用图表库展示用电量和费用趋势，支持按日、周、月、年查看。

2. **优化用户界面**：提升用户界面的美观度和用户体验，添加更多交互效果。

3. **添加更多设备类型支持**：支持多种类型的电表设备，包括智能电表和传统电表。

4. **实现数据导出功能**：支持将数据导出为Excel或PDF格式，便于数据分析和报表生成。

5. **添加系统日志**：记录系统操作日志，便于故障排查和安全审计。

6. **优化移动端适配**：提升系统在移动端的使用体验，支持响应式设计。

7. **添加定时任务**：实现自动抄表、定期数据备份等功能，减少人工操作。

8. **完善权限管理**：细化用户权限，支持更多角色和权限配置，提升系统安全性。

9. **添加预警功能**：当用电量异常时，系统自动发送预警通知，便于及时发现和处理问题。

10. **集成第三方服务**：集成短信通知、邮件通知等第三方服务，提升系统的扩展性。