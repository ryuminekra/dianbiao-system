# 远程抄电表系统开发文档

## 1. 项目概述

远程抄电表系统是一个用于管理电表设备、采集电表数据、分析用电情况的系统。系统支持用户认证、设备管理、电表数据采集与分析、电价设置、区域管理等功能，为用户提供便捷的用电管理服务。

### 1.1 主要功能

- **用户认证**：登录、注册、个人资料管理、用户管理
- **设备管理**：硬件设备的添加、编辑、删除
- **电表数据**：电表概览、电表详情、手动录入电表度数
- **电价设置**：设置不同区域的电价
- **区域管理**：区域、楼层、房间的管理
- **数据分析**：用电量和费用的计算

### 1.2 系统架构

系统采用前后端分离架构：
- **前端**：React + TypeScript + Ant Design + Vite
- **后端**：Node.js + Express + MongoDB
- **通信**：RESTful API

## 2. 技术栈

### 2.1 前端技术栈

| 技术/库 | 版本 | 用途 |
|---------|------|------|
| React | 19.2.0 | 前端框架 |
| TypeScript | 5.9.3 | 类型系统 |
| Ant Design | 6.2.3 | UI组件库 |
| React Router | 7.13.0 | 路由管理 |
| Axios | 1.13.4 | HTTP客户端 |
| Redux Toolkit | 2.11.2 | 状态管理 |
| Vite | 7.2.4 | 构建工具 |

### 2.2 后端技术栈

| 技术/库 | 版本 | 用途 |
|---------|------|------|
| Node.js | - | 运行环境 |
| Express | 5.2.1 | Web框架 |
| MongoDB | - | 数据库 |
| Mongoose | 9.1.6 | ODM库 |
| JWT | 9.0.3 | 身份认证 |
| BCrypt | 6.0.0 | 密码加密 |
| CORS | 2.8.6 | 跨域中间件 |
| Dotenv | 17.2.4 | 环境变量管理 |

## 3. 目录结构

### 3.1 前端目录结构

```
dianbiao-app/
├── public/                 # 静态资源
│   └── vite.svg
├── src/                    # 源代码
│   ├── assets/             # 资源文件
│   │   └── react.svg
│   ├── pages/              # 页面组件
│   │   ├── AreaSettingPage.tsx        # 区域设置页面
│   │   ├── ElectricityPricePage.tsx    # 电价设置页面
│   │   ├── HardwareManagementPage.tsx  # 硬件管理页面
│   │   ├── LoginPage.tsx               # 登录页面
│   │   ├── ManualMeterReadingPage.tsx  # 手动填写电表数
│   │   ├── MeterDetailPage.tsx         # 电表详情页面
│   │   ├── MeterOverviewPage.tsx       # 电表概览页面
│   │   ├── UserManagementPage.tsx      # 用户管理页面
│   │   └── UserProfilePage.tsx         # 个人资料页面
│   ├── store/              # 状态管理
│   │   └── index.ts
│   ├── types/              # 类型定义
│   │   └── index.ts
│   ├── App.css             # 应用样式
│   ├── App.tsx              # 应用主组件
│   ├── index.css           # 全局样式
│   └── main.tsx            # 应用入口
├── .gitignore              # Git忽略文件
├── README.md               # 项目说明
├── eslint.config.js        # ESLint配置
├── index.html              # HTML模板
├── package-lock.json        # 依赖锁定文件
├── package.json             # 项目配置
├── tsconfig.app.json       # TypeScript应用配置
├── tsconfig.json            # TypeScript配置
├── tsconfig.node.json       # TypeScript节点配置
└── vite.config.ts           # Vite配置
```

### 3.2 后端目录结构

```
dianbiao-backend/
├── middleware/             # 中间件
│   └── auth.js             # 认证中间件
├── models/                 # 数据模型
│   ├── Area.js             # 区域模型
│   ├── Building.js          # 大楼模型
│   ├── Device.js            # 设备模型
│   ├── ElectricityPrice.js  # 电价模型
│   ├── Floor.js             # 楼层模型
│   ├── Metric.js            # 电表数据模型
│   ├── Room.js              # 房间模型
│   └── User.js              # 用户模型
├── routes/                 # 路由
│   ├── areas.js             # 区域路由
│   ├── auth.js              # 认证路由
│   ├── devices.js           # 设备路由
│   ├── metrics.js           # 电表数据路由
│   └── prices.js            # 电价路由
├── index.js                # 应用入口
├── init-data.js            # 初始化数据
├── package-lock.json        # 依赖锁定文件
└── package.json             # 项目配置
```

## 4. 数据库设计

### 4.1 用户模型 (User)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 用户ID | 主键 |
| username | String | 用户名 | 唯一，必填 |
| password | String | 密码 | 必填 |
| role | String | 角色 | 枚举(admin, user) |
| avatar | String | 头像URL | - |
| created_at | Date | 创建时间 | 默认当前时间 |
| updated_at | Date | 更新时间 | 默认当前时间 |

### 4.2 设备模型 (Device)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 设备ID | 主键 |
| device_id | String | 设备编号 | 唯一，必填 |
| area | String | 区域 | 必填 |
| address | String | 地址 | 必填 |
| created_at | Date | 创建时间 | 默认当前时间 |
| updated_at | Date | 更新时间 | 默认当前时间 |

### 4.3 电表数据模型 (Metric)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 数据ID | 主键 |
| device_id | ObjectId | 设备ID | 外键(Device)，必填 |
| value | Number | 电表读数 | 必填 |
| timestamp | Date | 时间戳 | 默认当前时间 |
| month | String | 月份 | 格式(YYYY-MM)，必填 |

### 4.4 电价模型 (ElectricityPrice)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 电价ID | 主键 |
| area | String | 区域 | 必填 |
| price | Number | 电价 | 必填 |
| effective_date | Date | 生效日期 | 默认当前时间 |
| created_at | Date | 创建时间 | 默认当前时间 |
| updated_at | Date | 更新时间 | 默认当前时间 |

### 4.5 区域模型 (Area)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 区域ID | 主键 |
| name | String | 区域名称 | 唯一，必填 |
| created_at | Date | 创建时间 | 默认当前时间 |
| updated_at | Date | 更新时间 | 默认当前时间 |

### 4.6 楼层模型 (Floor)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 楼层ID | 主键 |
| name | String | 楼层名称 | 必填 |
| area_id | ObjectId | 区域ID | 外键(Area)，必填 |
| created_at | Date | 创建时间 | 默认当前时间 |
| updated_at | Date | 更新时间 | 默认当前时间 |

### 4.7 房间模型 (Room)

| 字段名 | 类型 | 描述 | 约束 |
|--------|------|------|------|
| _id | ObjectId | 房间ID | 主键 |
| name | String | 房间名称 | 必填 |
| floor_id | ObjectId | 楼层ID | 外键(Floor)，必填 |
| created_at | Date | 创建时间 | 默认当前时间 |
| updated_at | Date | 更新时间 | 默认当前时间 |

## 5. API接口设计

### 5.1 认证相关接口

| 方法 | 路径 | 功能 | 请求体 | 响应 |
|------|------|------|--------|------|
| POST | /api/auth/login | 用户登录 | `{"username": "admin", "password": "123456"}` | `{"user": {...}, "token": "..."}` |
| POST | /api/auth/register | 用户注册 | `{"username": "user", "password": "123456"}` | `{"user": {...}, "token": "..."}` |
| GET | /api/auth/me | 获取当前用户 | N/A | `{"_id": "...", "username": "...", "role": "..."}` |
| PUT | /api/auth/profile | 更新用户资料 | `{"avatar": "..."}` | `{"_id": "...", "username": "...", "avatar": "..."}` |
| PUT | /api/auth/password | 修改密码 | `{"oldPassword": "...", "newPassword": "..."}` | `{"message": "密码修改成功"}` |
| PUT | /api/auth/users/:id/role | 更新用户角色 | `{"role": "admin"}` | `{"_id": "...", "username": "...", "role": "admin"}` |

### 5.2 设备相关接口

| 方法 | 路径 | 功能 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | /api/devices | 获取设备列表 | N/A | `[{"_id": "...", "device_id": "...", "area": "...", "address": "..."}]` |
| GET | /api/devices/:id | 获取设备详情 | N/A | `{"_id": "...", "device_id": "...", "area": "...", "address": "..."}` |
| POST | /api/devices | 添加设备 | `{"device_id": "...", "area": "...", "address": "..."}` | `{"_id": "...", "device_id": "...", "area": "...", "address": "..."}` |
| PUT | /api/devices/:id | 更新设备 | `{"device_id": "...", "area": "...", "address": "..."}` | `{"_id": "...", "device_id": "...", "area": "...", "address": "..."}` |
| DELETE | /api/devices/:id | 删除设备 | N/A | `{"message": "设备删除成功"}` |

### 5.3 电表数据相关接口

| 方法 | 路径 | 功能 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | /api/metrics/device/:deviceId | 获取设备的电表数据 | N/A | `[{"_id": "...", "device_id": "...", "value": 100, "timestamp": "...", "month": "2024-01"}]` |
| GET | /api/metrics/overview | 获取所有电表的最新数据 | N/A | `[{"device_id": "...", "device_number": "...", "area": "...", "address": "...", "current_reading": 100, "last_updated": "..."}]` |
| GET | /api/metrics/monthly/:deviceId | 计算月度用电量和费用 | N/A | `{"usage": 50, "cost": 25, "price": 0.5, "data": [...]}` |
| POST | /api/metrics | 添加电表数据 | `{"device_id": "...", "value": 100}` | `{"_id": "...", "device_id": "...", "value": 100, "timestamp": "...", "month": "2024-01"}` |

### 5.4 电价相关接口

| 方法 | 路径 | 功能 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | /api/prices | 获取电价列表 | N/A | `[{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}]` |
| POST | /api/prices | 添加电价 | `{"area": "...", "price": 0.5}` | `{"_id": "...", "area": "...", "price": 0.5, "effective_date": "..."}` |
| PUT | /api/prices/:id | 更新电价 | `{"area": "...", "price": 0.6}` | `{"_id": "...", "area": "...", "price": 0.6, "effective_date": "..."}` |
| DELETE | /api/prices/:id | 删除电价 | N/A | `{"message": "电价删除成功"}` |

### 5.5 区域相关接口

| 方法 | 路径 | 功能 | 请求体 | 响应 |
|------|------|------|--------|------|
| GET | /api/areas | 获取区域列表 | N/A | `[{"_id": "...", "name": "...", "created_at": "..."}]` |
| GET | /api/areas/:id | 获取区域详情 | N/A | `{"_id": "...", "name": "...", "created_at": "..."}` |
| POST | /api/areas | 添加区域 | `{"name": "..."}` | `{"_id": "...", "name": "...", "created_at": "..."}` |
| PUT | /api/areas/:id | 更新区域 | `{"name": "..."}` | `{"_id": "...", "name": "...", "updated_at": "..."}` |
| DELETE | /api/areas/:id | 删除区域 | N/A | `{"message": "区域删除成功"}` |
| GET | /api/areas/:areaId/floors | 获取区域下的楼层 | N/A | `[{"_id": "...", "name": "...", "area_id": "...", "created_at": "..."}]` |
| POST | /api/areas/:areaId/floors | 添加楼层 | `{"name": "..."}` | `{"_id": "...", "name": "...", "area_id": "...", "created_at": "..."}` |
| PUT | /api/areas/floors/:id | 更新楼层 | `{"name": "..."}` | `{"_id": "...", "name": "...", "updated_at": "..."}` |
| DELETE | /api/areas/floors/:id | 删除楼层 | N/A | `{"message": "楼层删除成功"}` |
| GET | /api/areas/:floorId/rooms | 获取楼层下的房间 | N/A | `[{"_id": "...", "name": "...", "floor_id": "...", "created_at": "..."}]` |
| POST | /api/areas/:floorId/rooms | 添加房间 | `{"name": "..."}` | `{"_id": "...", "name": "...", "floor_id": "...", "created_at": "..."}` |
| PUT | /api/areas/rooms/:id | 更新房间 | `{"name": "..."}` | `{"_id": "...", "name": "...", "updated_at": "..."}` |
| DELETE | /api/areas/rooms/:id | 删除房间 | N/A | `{"message": "房间删除成功"}` |

## 6. 前端页面设计

### 6.1 登录页面 (LoginPage.tsx)

- **功能**：用户登录
- **组件**：表单、输入框、按钮
- **流程**：
  1. 用户输入用户名和密码
  2. 点击登录按钮
  3. 验证用户凭证
  4. 登录成功后跳转到首页

### 6.2 电表概览页面 (MeterOverviewPage.tsx)

- **功能**：显示所有电表的最新数据
- **组件**：表格、搜索框、筛选器
- **流程**：
  1. 获取所有设备的最新电表数据
  2. 显示设备列表，包括设备编号、区域、地址、当前读数、最后更新时间
  3. 支持按区域筛选
  4. 点击设备跳转到电表详情页面

### 6.3 电表详情页面 (MeterDetailPage.tsx)

- **功能**：显示单个电表的详细数据和用电分析
- **组件**：图表、表格、日期选择器
- **流程**：
  1. 获取指定设备的电表数据
  2. 显示设备基本信息
  3. 显示电表读数历史记录
  4. 计算并显示月度用电量和费用
  5. 支持按月份筛选

### 6.4 硬件管理页面 (HardwareManagementPage.tsx)

- **功能**：管理硬件设备
- **组件**：表格、表单、模态框、按钮
- **流程**：
  1. 获取设备列表
  2. 支持添加、编辑、删除设备
  3. 显示设备详情

### 6.5 电价设置页面 (ElectricityPricePage.tsx)

- **功能**：设置不同区域的电价
- **组件**：表格、表单、模态框、按钮
- **流程**：
  1. 获取电价列表
  2. 支持添加、编辑、删除电价
  3. 显示电价详情

### 6.6 手动录入电表度数页面 (ManualMeterReadingPage.tsx)

- **功能**：手动录入电表度数
- **组件**：表单、下拉菜单、输入框、按钮、表格
- **流程**：
  1. 获取设备列表
  2. 用户选择设备
  3. 填写电表数字
  4. 提交电表数字
  5. 显示设备的最近电表读数

### 6.7 区域设置页面 (AreaSettingPage.tsx)

- **功能**：管理区域、楼层、房间
- **组件**：树形结构、表单、模态框、按钮
- **流程**：
  1. 显示区域、楼层、房间的树形结构
  2. 支持添加、编辑、删除区域、楼层、房间
  3. 支持层级操作，区域可以添加楼层，楼层可以添加房间

### 6.8 个人资料页面 (UserProfilePage.tsx)

- **功能**：管理个人资料和密码
- **组件**：表单、输入框、按钮、头像上传
- **流程**：
  1. 显示用户基本信息
  2. 支持修改头像
  3. 支持修改密码

### 6.9 用户管理页面 (UserManagementPage.tsx)

- **功能**：管理用户账号
- **组件**：表格、按钮、下拉菜单
- **流程**：
  1. 获取用户列表
  2. 显示用户基本信息
  3. 支持修改用户角色

## 7. 前端路由配置

| 路径 | 组件 | 权限 | 描述 |
|------|------|------|------|
| /login | LoginPage | 公开 | 登录页面 |
| / | MeterOverviewPage | 登录用户 | 电表概览页面 |
| /hardware | HardwareManagementPage | 管理员 | 硬件管理页面 |
| /price | ElectricityPricePage | 管理员 | 电价设置页面 |
| /meter/:deviceId | MeterDetailPage | 登录用户 | 电表详情页面 |
| /user/profile | UserProfilePage | 登录用户 | 个人资料页面 |
| /users | UserManagementPage | 管理员 | 用户管理页面 |
| /manual | ManualMeterReadingPage | 登录用户 | 手动录入电表度数页面 |
| /area | AreaSettingPage | 管理员 | 区域设置页面 |

## 8. 部署说明

### 8.1 前端部署

1. **安装依赖**：
   ```bash
   cd dianbiao-app
   npm install
   ```

2. **构建项目**：
   ```bash
   npm run build
   ```

3. **部署到服务器**：
   - 将 `dist` 目录下的文件上传到服务器
   - 配置 Nginx 或其他 Web 服务器指向 `dist` 目录

### 8.2 后端部署

1. **安装依赖**：
   ```bash
   cd dianbiao-backend
   npm install
   ```

2. **配置环境变量**：
   - 创建 `.env` 文件
   - 配置 MongoDB 连接字符串：`MONGO_URI=mongodb://localhost:27017/dianbiao`
   - 配置 JWT 密钥：`JWT_SECRET=your-secret-key`

3. **启动服务器**：
   ```bash
   node index.js
   ```

4. **使用 PM2 管理进程**（可选）：
   ```bash
   npm install -g pm2
   pm2 start index.js --name dianbiao-backend
   ```

### 8.3 数据库部署

1. **安装 MongoDB**：
   - 下载并安装 MongoDB
   - 启动 MongoDB 服务

2. **创建数据库**：
   - 连接 MongoDB：`mongo`
   - 创建数据库：`use dianbiao`

3. **初始化数据**（可选）：
   - 运行初始化脚本：`node init-data.js`

## 9. 开发说明

### 9.1 前端开发

1. **启动开发服务器**：
   ```bash
   cd dianbiao-app
   npm run dev
   ```

2. **代码风格**：
   - 使用 ESLint 检查代码风格
   - 遵循 TypeScript 类型定义规范

3. **组件开发**：
   - 组件命名使用 PascalCase
   - 文件命名与组件名称保持一致
   - 使用 Ant Design 组件库

### 9.2 后端开发

1. **启动开发服务器**：
   ```bash
   cd dianbiao-backend
   node index.js
   ```

2. **API 设计**：
   - 遵循 RESTful API 设计规范
   - 使用 HTTP 状态码表示请求结果
   - 返回 JSON 格式数据

3. **中间件使用**：
   - 使用 `auth.js` 中间件进行身份认证
   - 使用 `express.json()` 中间件解析 JSON 请求体
   - 使用 `cors()` 中间件处理跨域请求

## 10. 安全注意事项

1. **密码加密**：
   - 使用 BCrypt 对密码进行加密存储
   - 禁止明文存储密码

2. **身份认证**：
   - 使用 JWT 进行身份认证
   - 设置合理的 token 过期时间
   - 验证 token 有效性

3. **权限控制**：
   - 对敏感操作进行权限检查
   - 管理员权限与普通用户权限分离

4. **输入验证**：
   - 对所有用户输入进行验证
   - 防止 SQL 注入和 XSS 攻击

5. **CORS 配置**：
   - 合理配置 CORS 策略
   - 限制允许的源、方法和头部

6. **错误处理**：
   - 统一错误处理
   - 避免在响应中暴露敏感错误信息

## 11. 系统优化

1. **性能优化**：
   - 使用索引优化数据库查询
   - 实现分页加载大量数据
   - 使用缓存减少重复请求

2. **代码优化**：
   - 代码模块化
   - 避免冗余代码
   - 提高代码可读性和可维护性

3. **用户体验优化**：
   - 响应式设计，适配不同设备
   - 加载状态反馈
   - 错误提示和成功反馈

## 12. 总结

远程抄电表系统是一个功能完整、架构清晰的用电管理系统。系统采用前后端分离架构，使用现代技术栈开发，具有良好的可扩展性和可维护性。系统支持用户认证、设备管理、电表数据采集与分析、电价设置、区域管理等功能，为用户提供便捷的用电管理服务。

通过本系统，用户可以：
- 实时查看电表数据和用电情况
- 手动录入电表度数
- 管理硬件设备
- 设置不同区域的电价
- 管理区域、楼层、房间
- 分析用电数据，优化用电计划

系统的开发遵循了现代软件工程实践，包括模块化设计、API 规范、安全措施等，为后续的功能扩展和系统维护奠定了良好的基础。